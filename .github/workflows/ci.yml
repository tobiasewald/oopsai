name: Oops.ai CI Pipeline

on:
  push:
    branches: [ master ]

env:
  CRITICALITY_THRESHOLD: 8.0
  KUBE_NAMESPACE: oops-ai
  DEPLOYMENT_NAME: oops-ai-frontend
  OLLAMA_API_URL: ${{ secrets.OLLAMA_API_URL }}
  DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

jobs:

  renovate:
    runs-on: self-hosted
    steps:
      - name: Run Renovate
        run: renovate
        env:
          RENOVATE_PLATFORM: github
          RENOVATE_TOKEN: ${{ secrets.RENOVATE_TOKEN }}
          RENOVATE_REPOSITORIES: tobiasewald/oopsai

  trivy_scan:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Run Trivy
        run: |
          docker run --rm -v ${{ github.workspace }}:/project aquasec/trivy fs /project > trivy-report.json

  owasp_scan:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Run OWASP Dependency Check
        run: |
          chmod +x scripts/run_owasp.sh
          ./scripts/run_owasp.sh

  ai_analysis:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Run LLM Analysis
        run: |
          pip install requests
          python scripts/ai_processor.py
          ./scripts/check_criticality.sh

  deploy_production:
    needs: ai_analysis
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f kubernetes/ -n $KUBE_NAMESPACE

  auto_rollback:
    if: failure()
    needs: ai_analysis
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Rollback Deployment
        run: |
          echo "Critical vulnerabilities detected! Initiating rollback..."
          kubectl rollout undo deployment/$DEPLOYMENT_NAME -n $KUBE_NAMESPACE
          ./scripts/send_rollback_notification.sh

  discord_notify:
    needs: ai_analysis
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Notify Discord
        run: |
          curl -sL https://github.com/stedolan/jq/releases/latest/download/jq-win64.exe -o jq.exe
          export CRIT=$(jq.exe -r '.criticality' ai_response.json)
          export COMMENT=$(jq.exe -r '.comment' ai_response.json)
          export MEME=$(jq.exe -r '.meme' ai_meme.json)
          curl -X POST -H "Content-Type: application/json" \
            -d "$(jq.exe -n --arg crit \"$CRIT\" \
                         --arg comment \"$COMMENT\" \
                         --arg meme \"$MEME\" \
            '{content: "\ud83d\udea8 **Sicherheitsanalyse abgeschlossen**\\n\\n\ud83d\udd22 *Criticality:* \($crit)/10\\n\ud83e\udde0 *Kommentar:* \($comment)\\n\\n\ud83c\udf1d *Meme:* \($meme)"}')" \
            "$DISCORD_WEBHOOK"
